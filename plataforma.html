<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V-Exclusive</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #fa0050; --bg: #000000; --card: #121212; --text: #ffffff; --gray: #888; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }

        /* ANIMACIONES Y TRANSICIONES */
        .view-section { 
            display: none; 
            opacity: 0; 
            transform: translateY(10px); 
            transition: all 0.3s ease-in-out; 
            height: 100%;
            overflow-y: auto;
            scrollbar-width: none;
        }
        .view-section.active-view { 
            display: block; 
            opacity: 1; 
            transform: translateY(0); 
        }

        /* SIDEBAR */
        aside { width: 260px; padding: 30px; border-right: 1px solid #222; display: flex; flex-direction: column; z-index: 50; }
        .logo { font-size: 2rem; font-weight: 800; color: white; margin-bottom: 40px; }
        .logo span { color: var(--primary); }
        .menu-item { display: flex; align-items: center; gap: 15px; padding: 15px; color: var(--gray); cursor: pointer; transition: 0.3s; border-radius: 15px; margin-bottom: 5px; font-weight: 600; }
        .menu-item:hover { background: #1a1a1a; color: white; }
        .menu-item.active { color: white; background: #1a1a1a; border-left: 4px solid var(--primary); }
        .menu-item.active i { color: var(--primary); }
        
        /* AREA PRINCIPAL */
        main { flex: 1; position: relative; height: 100%; }
        .feed-container { max-width: 550px; margin: 0 auto; padding: 20px 0 100px 0; }
        
        /* POSTS */
        .post { background: var(--card); border-radius: 0; border-bottom: 1px solid #222; margin-bottom: 10px; overflow: hidden; }
        @media(min-width: 768px) { .post { border-radius: 20px; border: 1px solid #222; margin-bottom: 20px; } }
        
        .post-header { padding: 15px; display: flex; align-items: center; justify-content: space-between; }
        .user-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #333; }
        .username { font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; gap: 4px; }
        .badge-verified { color: #3897f0; font-size: 14px; } 

        .post-img-box { position: relative; width: 100%; background: #000; display: flex; justify-content: center; align-items: center; min-height: 300px; }
        .post-img { width: 100%; max-height: 650px; object-fit: cover; display: block; }
        
        /* ESTADO BLOQUEADO */
        .locked-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; padding: 20px; text-align: center; }
        .locked-title { font-size: 20px; font-weight: 800; margin-bottom: 5px; }
        .locked-price { color: var(--primary); font-size: 24px; font-weight: 900; margin-bottom: 15px; }
        .unlock-btn { background: white; color: black; border: none; padding: 12px 25px; border-radius: 30px; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .unlock-btn:hover { transform: scale(1.05); background: var(--primary); color: white; }

        .post-actions { padding: 15px; display: flex; gap: 20px; }
        .action-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .action-btn.liked { color: var(--primary); }

        /* PERFIL */
        .cover-img { width: 100%; height: 200px; object-fit: cover; opacity: 0.8; mask-image: linear-gradient(to bottom, black 50%, transparent 100%); }
        .profile-header { position: relative; margin-top: -60px; padding: 0 20px; display: flex; justify-content: space-between; align-items: flex-end; }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; border: 4px solid black; background: #222; object-fit: cover; }
        .edit-btn { background: transparent; border: 1px solid #444; color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; }
        
        .profile-info { padding: 10px 20px; }
        .profile-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; margin-top: 20px; }
        .grid-item { aspect-ratio: 1/1; position: relative; cursor: pointer; background: #222; }
        .grid-img { width: 100%; height: 100%; object-fit: cover; }

        /* FAB */
        .fab-btn { position: fixed; bottom: 30px; right: 30px; background: var(--primary); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 10px 30px rgba(250, 0, 80, 0.4); cursor: pointer; border: none; z-index: 100; transition: transform 0.2s; }
        .fab-btn:hover { transform: scale(1.1) rotate(90deg); }

        /* MODALES */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #111; padding: 25px; border-radius: 20px; width: 95%; max-width: 450px; border: 1px solid #333; max-height: 90vh; overflow-y: auto; }
        .input-field { width: 100%; padding: 15px; background: #000; border: 1px solid #333; color: white; border-radius: 12px; margin: 10px 0; outline: none; }
        .input-field:focus { border-color: var(--primary); }
        .primary-btn { width: 100%; background: var(--primary); border: none; padding: 15px; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 1rem; }
        
        /* NOTIFICACIONES */
        .notif-badge { background: var(--primary); color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; position: absolute; top: 10px; right: 10px; display: none; }

        /* MOBILE NAV */
        .mobile-nav { display: none; position: fixed; bottom: 0; width: 100%; background: black; border-top: 1px solid #222; padding: 15px; justify-content: space-around; z-index: 90; }
        @media (max-width: 768px) { aside { display: none; } .mobile-nav { display: flex; } .fab-btn { bottom: 80px; } }
    </style>
</head>
<body>

    <aside>
        <div class="logo">V<span>EX</span></div>
        <div class="menu-item active" id="nav-home" onclick="navTo('feed')">
            <i class="fas fa-home"></i> Inicio
        </div>
        <div class="menu-item" id="nav-profile" onclick="navTo('myProfile')">
            <i class="fas fa-user"></i> Mi Perfil
        </div>
        <div class="menu-item" id="nav-requests" onclick="navTo('requests')">
            <div style="position:relative;">
                <i class="fas fa-bell"></i>
                <div id="side-notif" class="notif-badge">!</div>
            </div>
             Ventas / Solicitudes
        </div>
        <button onclick="doLogout()" style="margin-top:auto; background:#222; border:none; color:white; padding:15px; border-radius:10px; cursor:pointer; display:flex; gap:10px; align-items:center;">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
        </button>
    </aside>

    <main>
        
        <div id="view-feed" class="view-section active-view">
            <div style="padding: 20px; font-weight:800; font-size:1.5rem; border-bottom:1px solid #222; position:sticky; top:0; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px); z-index:5;">
                Inicio
            </div>
            <div class="feed-container" id="feed-container"></div>
        </div>

        <div id="view-profile" class="view-section">
            <img id="p-cover" class="cover-img" src="">
            <div class="profile-header">
                <img id="p-avatar" class="profile-avatar" src="">
                <div style="display:flex; gap:10px;">
                    <button id="btn-config-pay" class="edit-btn" onclick="openConfigPay()" style="display:none; border-color:var(--primary); color:var(--primary);">
                        <i class="fas fa-wallet"></i> Métodos Pago
                    </button>
                    <button id="btn-edit-profile" class="edit-btn" onclick="openBioModal()" style="display:none;">Editar Perfil</button>
                </div>
            </div>
            <div class="profile-info">
                <h2 style="display:flex; align-items:center; gap:5px;">
                    <span id="p-name">@usuario</span>
                    <i id="p-badge" class="fas fa-check-circle badge-verified" style="display:none;"></i>
                </h2>
                <p id="p-bio" style="color:#aaa; margin-top:5px; font-size:0.95rem;">Sin biografía.</p>
                <p id="p-pay-info" style="color:#666; font-size:0.8rem; margin-top:5px; display:none;"><i class="fas fa-info-circle"></i> Acepta pagos externos</p>
            </div>
            
            <hr style="border:0; border-top:1px solid #222; margin: 10px 0;">
            
            <div class="profile-grid" id="profile-grid"></div>
            <div style="height:100px;"></div>
        </div>

        <div id="view-requests" class="view-section">
            <div style="padding: 20px; font-weight:800; font-size:1.5rem;">Solicitudes de Acceso</div>
            <div id="requests-container" class="feed-container">
                <p style="color:#666; text-align:center;">No tienes ventas pendientes por aprobar.</p>
            </div>
        </div>

    </main>

    <nav class="mobile-nav">
        <i class="fas fa-home" onclick="navTo('feed')" style="font-size:1.5rem; color:white;"></i>
        <i class="fas fa-bell" onclick="navTo('requests')" style="font-size:1.5rem; color:#666;"></i>
        <i class="fas fa-user" onclick="navTo('myProfile')" style="font-size:1.5rem; color:#666;"></i>
    </nav>

    <button class="fab-btn" onclick="document.getElementById('uploadModal').style.display='flex'">
        <i class="fas fa-plus"></i>
    </button>

    <div class="modal" id="postDetailModal" onclick="if(event.target === this) this.style.display='none'">
        <div class="modal-content" style="max-width:500px; padding:0; overflow:hidden;">
            <div id="detail-content"></div>
        </div>
    </div>

    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <h3>Nueva Publicación</h3>
            <input type="file" id="fileInput" class="input-field" accept="image/*">
            <input type="number" id="postPrice" class="input-field" placeholder="Precio en $ (0 para Gratis)">
            <p style="font-size:12px; color:#666; margin-bottom:10px;">Si pones precio, los usuarios deberán enviarte el comprobante de pago.</p>
            <button onclick="uploadPost()" class="primary-btn">PUBLICAR</button>
            <button onclick="document.getElementById('uploadModal').style.display='none'" style="background:transparent; color:#888; border:none; width:100%; margin-top:10px; cursor:pointer;">Cancelar</button>
        </div>
    </div>

    <div class="modal" id="configPayModal">
        <div class="modal-content">
            <h3>Tus Datos Bancarios</h3>
            <p style="font-size:12px; color:#aaa; margin-bottom:10px;">Estos datos se mostrarán a quien quiera desbloquear tu contenido.</p>
            <textarea id="payMethodsInput" class="input-field" rows="5" placeholder="Ej: Pago Móvil: 0412... C.I: ... Banco: ... &#10;Binance ID: ..."></textarea>
            <button onclick="savePayMethods()" class="primary-btn">GUARDAR DATOS</button>
            <button onclick="document.getElementById('configPayModal').style.display='none'" style="background:transparent; color:#888; border:none; width:100%; margin-top:10px; cursor:pointer;">Cerrar</button>
        </div>
    </div>

    <div class="modal" id="unlockModal">
        <div class="modal-content">
            <h3>Desbloquear Contenido</h3>
            <p style="color:#aaa; font-size:13px;">Envía el dinero a las cuentas del creador:</p>
            
            <div id="creator-pay-info" style="background:#222; padding:15px; border-radius:10px; margin:10px 0; font-family:monospace; white-space: pre-wrap; color: var(--primary);">
                Cargando datos...
            </div>

            <p style="color:white; font-size:14px; margin-top:15px;">Sube el Comprobante (Capture):</p>
            <input type="file" id="proofFile" class="input-field" accept="image/*">
            
            <button onclick="sendUnlockRequest()" class="primary-btn">ENVIAR COMPROBANTE</button>
            <button onclick="closeUnlockModal()" style="background:transparent; color:#888; border:none; width:100%; margin-top:10px; cursor:pointer;">Cancelar</button>
        </div>
    </div>

    <div class="modal" id="bioModal">
        <div class="modal-content">
            <h3>Editar Perfil</h3>
            <textarea id="bioInput" class="input-field" rows="3" placeholder="Biografía..."></textarea>
            <p style="font-size:12px; color:#666;">Toca tu foto en el perfil para cambiarla.</p>
            <button onclick="saveBio()" class="primary-btn">Guardar</button>
            <button onclick="document.getElementById('bioModal').style.display='none'" style="background:transparent; color:#888; border:none; width:100%; margin-top:10px; cursor:pointer;">Cancelar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, arrayUnion, arrayRemove, where, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
             apiKey: "AIzaSyA-y05rnK5lD_v3G7YPS2wE1LlmAjrTz9c",
            authDomain: "v-exclusive.firebaseapp.com",
            projectId: "v-exclusive",
            storageBucket: "v-exclusive.firebasestorage.app",
            messagingSenderId: "312654319716",
            appId: "1:312654319716:web:eca438a0a4f0f9050f0f71"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let myData = null;
        let currentPostIdToUnlock = null;
        let currentCreatorIdToPay = null;

        // --- SISTEMA DE NAVEGACIÓN ---
        window.navTo = (viewName) => {
            // Ocultar todas
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
            // Quitar active del menu
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));

            // Mostrar la elegida
            if(viewName === 'feed') {
                document.getElementById('view-feed').classList.add('active-view');
                document.getElementById('nav-home').classList.add('active');
            } else if (viewName === 'myProfile') {
                loadProfile(myData.id);
                document.getElementById('view-profile').classList.add('active-view');
                document.getElementById('nav-profile').classList.add('active');
            } else if (viewName === 'requests') {
                loadRequests();
                document.getElementById('view-requests').classList.add('active-view');
                document.getElementById('nav-requests').classList.add('active');
            } else if (viewName === 'otherProfile') {
                document.getElementById('view-profile').classList.add('active-view');
                // No activamos ningun menu item
            }
        };

        window.doLogout = () => {
            signOut(auth).then(() => window.location.href = "index.html");
        };

        // AUTH
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "usuarios", user.uid));
                if(snap.exists()){
                    myData = { id: user.uid, ...snap.data() };
                    loadFeed(); 
                    checkNotifications();
                }
            } else {
                window.location.href = "index.html";
            }
        });

        // --- FEED LOGIC ---
        function loadFeed() {
            const container = document.getElementById('feed-container');
            const q = query(collection(db, "posts"), orderBy("fecha", "desc"));
            
            onSnapshot(q, (snap) => {
                container.innerHTML = "";
                snap.forEach(docSnap => {
                    const post = docSnap.data();
                    renderPost(docSnap.id, post, container);
                });
            });
        }

        function renderPost(pid, post, parentElement) {
            // Lógica de acceso: Es dueño O pagó O es gratis
            const isOwner = post.creadorId === myData.id;
            const hasAccess = isOwner || post.precio === 0 || (post.accesos && post.accesos.includes(myData.id));
            const isPending = post.solicitudes && post.solicitudes.some(req => req.userId === myData.id);
            const isLiked = post.likes && post.likes.includes(myData.id);

            let html = `
            <div class="post">
                <div class="post-header">
                    <div class="user-info" onclick="openUserProfile('${post.creadorId}')">
                        <img src="${post.creadorFoto || 'https://via.placeholder.com/40'}" class="avatar">
                        <div class="username">
                            @${post.creador} 
                            ${post.verificado ? '<i class="fas fa-check-circle badge-verified"></i>' : ''}
                        </div>
                    </div>
                    ${isOwner ? `<i class="fas fa-trash" onclick="deletePost('${pid}')" style="color:#444; cursor:pointer;"></i>` : ''}
                </div>

                <div class="post-img-box">
                    ${hasAccess ? 
                        `<img src="${post.url}" class="post-img">` : 
                        `<div class="locked-overlay">
                            <i class="fas fa-lock" style="font-size:40px; color:var(--primary); margin-bottom:10px;"></i>
                            <div class="locked-title">CONTENIDO EXCLUSIVO</div>
                            <div class="locked-price">$${post.precio}</div>
                            
                            ${isPending ? 
                                `<button class="unlock-btn" style="background:#444; color:white; cursor:default;">VERIFICANDO PAGO...</button>` : 
                                `<button class="unlock-btn" onclick="initUnlock('${pid}', '${post.creadorId}', ${post.precio})">DESBLOQUEAR</button>`
                            }
                        </div>
                        <img src="${post.url}" class="post-img" style="filter:blur(30px); opacity:0.5;">`
                    }
                </div>

                <div class="post-actions">
                    <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${pid}', ${isLiked})">
                        <i class="${isLiked ? 'fas' : 'far'} fa-heart"></i>
                        <span>${post.likes ? post.likes.length : 0}</span>
                    </button>
                </div>
            </div>`;
            
            // Si es feed, append. Si es modal detail, replace.
            if(parentElement.id === 'detail-content') parentElement.innerHTML = html;
            else parentElement.innerHTML += html;
        }

        // --- PERFIL LOGIC ---
        window.openUserProfile = (uid) => {
            if(uid === myData.id) navTo('myProfile');
            else {
                loadProfile(uid);
                navTo('otherProfile');
            }
        };

        async function loadProfile(uid) {
            const userSnap = await getDoc(doc(db, "usuarios", uid));
            if(!userSnap.exists()) return;
            const user = userSnap.data();
            const isMe = (uid === myData.id);

            // UI Header
            document.getElementById('p-name').innerText = "@" + user.username;
            document.getElementById('p-bio').innerText = user.biografia || "Sin biografía";
            document.getElementById('p-avatar').src = user.fotoPerfil || "https://via.placeholder.com/100";
            document.getElementById('p-cover').src = user.fotoPortada || "https://via.placeholder.com/500x200";
            document.getElementById('p-badge').style.display = user.verificado ? 'inline-block' : 'none';
            document.getElementById('p-pay-info').style.display = user.metodosPago ? 'block' : 'none';

            // Botones de config
            document.getElementById('btn-edit-profile').style.display = isMe ? 'block' : 'none';
            document.getElementById('btn-config-pay').style.display = isMe ? 'block' : 'none';

            if(isMe){
                document.getElementById('p-avatar').onclick = () => changePhoto('fotoPerfil');
                document.getElementById('p-cover').onclick = () => changePhoto('fotoPortada');
            } else {
                document.getElementById('p-avatar').onclick = null;
                document.getElementById('p-cover').onclick = null;
            }

            // Grid de fotos
            const grid = document.getElementById('profile-grid');
            grid.innerHTML = "";
            const q = query(collection(db, "posts"), where("creadorId", "==", uid), orderBy("fecha", "desc"));
            onSnapshot(q, (snap) => {
                grid.innerHTML = "";
                snap.forEach(d => {
                    const post = d.data();
                    const pid = d.id;
                    const hasAccess = isMe || post.precio === 0 || (post.accesos && post.accesos.includes(myData.id));
                    
                    const div = document.createElement('div');
                    div.className = 'grid-item';
                    div.innerHTML = `
                        ${!hasAccess ? '<div style="position:absolute; inset:0; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; color:white;"><i class="fas fa-lock"></i></div>' : ''}
                        <img src="${post.url}" class="grid-img" style="${!hasAccess ? 'filter:blur(5px)' : ''}">
                    `;
                    div.onclick = () => openPostDetail(pid);
                    grid.appendChild(div);
                });
            });
        }

        window.openPostDetail = async (pid) => {
            const snap = await getDoc(doc(db, "posts", pid));
            if(snap.exists()){
                const modal = document.getElementById('postDetailModal');
                const content = document.getElementById('detail-content');
                modal.style.display = 'flex';
                renderPost(pid, snap.data(), content);
            }
        };

        // --- SISTEMA DE PAGOS (MANUAL) ---

        // 1. Creador configura
        window.openConfigPay = async () => {
            const snap = await getDoc(doc(db, "usuarios", myData.id));
            document.getElementById('payMethodsInput').value = snap.data().metodosPago || "";
            document.getElementById('configPayModal').style.display = 'flex';
        };

        window.savePayMethods = async () => {
            const methods = document.getElementById('payMethodsInput').value;
            await updateDoc(doc(db, "usuarios", myData.id), { metodosPago: methods });
            alert("Datos guardados");
            document.getElementById('configPayModal').style.display = 'none';
        };

        // 2. Comprador inicia desbloqueo
        window.initUnlock = async (postId, creatorId, price) => {
            currentPostIdToUnlock = postId;
            currentCreatorIdToPay = creatorId;

            // Buscar datos del creador
            const cSnap = await getDoc(doc(db, "usuarios", creatorId));
            const methods = cSnap.data().metodosPago;

            if(!methods) return alert("Este creador no ha configurado sus métodos de pago aún.");

            document.getElementById('creator-pay-info').innerText = methods;
            document.getElementById('unlockModal').style.display = 'flex';
        };

        window.closeUnlockModal = () => {
             document.getElementById('unlockModal').style.display = 'none';
             document.getElementById('proofFile').value = "";
        }

        // 3. Comprador envía comprobante
        window.sendUnlockRequest = async () => {
            const file = document.getElementById('proofFile').files[0];
            if(!file) return alert("Debes subir el capture del pago");

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const proofBase64 = reader.result;
                
                // Guardar solicitud dentro del post
                const requestObj = {
                    userId: myData.id,
                    username: myData.username,
                    proof: proofBase64,
                    date: new Date().getTime()
                };

                await updateDoc(doc(db, "posts", currentPostIdToUnlock), {
                    solicitudes: arrayUnion(requestObj)
                });

                alert("Comprobante enviado. Espera a que el creador lo apruebe.");
                closeUnlockModal();
            };
        };

        // --- GESTIÓN DE VENTAS (CREADOR) ---
        function checkNotifications() {
            // Escuchar posts mios que tengan solicitudes
            const q = query(collection(db, "posts"), where("creadorId", "==", myData.id));
            onSnapshot(q, (snap) => {
                let hasNotifs = false;
                snap.forEach(d => {
                    const data = d.data();
                    if(data.solicitudes && data.solicitudes.length > 0) hasNotifs = true;
                });
                
                const badges = document.querySelectorAll('.notif-badge');
                badges.forEach(b => b.style.display = hasNotifs ? 'block' : 'none');
            });
        }

        function loadRequests() {
            const container = document.getElementById('requests-container');
            container.innerHTML = "";
            
            const q = query(collection(db, "posts"), where("creadorId", "==", myData.id));
            onSnapshot(q, (snap) => {
                container.innerHTML = "";
                let count = 0;
                snap.forEach(postDoc => {
                    const post = postDoc.data();
                    if(post.solicitudes && post.solicitudes.length > 0) {
                        post.solicitudes.forEach(req => {
                            count++;
                            container.innerHTML += `
                            <div class="post">
                                <div class="post-header">
                                    <span style="color:var(--primary); font-weight:bold;">Solicitud de @${req.username}</span>
                                    <span style="font-size:12px; color:#666;">$${post.precio}</span>
                                </div>
                                <div style="padding:15px;">
                                    <p style="margin-bottom:10px; font-size:14px;">Post: <i style="color:#aaa;">Post ID ...${postDoc.id.slice(-4)}</i></p>
                                    <img src="${req.proof}" style="width:100%; border-radius:10px; margin-bottom:15px; border:1px solid #333;">
                                    <div style="display:flex; gap:10px;">
                                        <button onclick="approveAccess('${postDoc.id}', '${req.userId}')" class="primary-btn" style="margin:0; background:green;">APROBAR</button>
                                        <button onclick="rejectAccess('${postDoc.id}', '${req.userId}')" class="primary-btn" style="margin:0; background:#333;">RECHAZAR</button>
                                    </div>
                                </div>
                            </div>`;
                        });
                    }
                });
                if(count === 0) container.innerHTML = "<p style='text-align:center; padding:20px; color:#666;'>No hay solicitudes pendientes.</p>";
            });
        }

        window.approveAccess = async (postId, userId) => {
            if(!confirm("¿Confirmas que recibiste el dinero?")) return;
            
            const postRef = doc(db, "posts", postId);
            const postSnap = await getDoc(postRef);
            const solicitudes = postSnap.data().solicitudes || [];
            
            // Filtrar la solicitud especifica
            const requestToRemove = solicitudes.find(r => r.userId === userId);

            await updateDoc(postRef, {
                accesos: arrayUnion(userId), // Dar acceso
                solicitudes: arrayRemove(requestToRemove) // Quitar de pendientes
            });
            alert("Acceso concedido.");
        };

        window.rejectAccess = async (postId, userId) => {
             if(!confirm("¿Rechazar solicitud?")) return;
             const postRef = doc(db, "posts", postId);
             const postSnap = await getDoc(postRef);
             const solicitudes = postSnap.data().solicitudes || [];
             const requestToRemove = solicitudes.find(r => r.userId === userId);
             
             await updateDoc(postRef, {
                solicitudes: arrayRemove(requestToRemove)
            });
        }

        // --- SUBIR POST ---
        window.uploadPost = async () => {
            const file = document.getElementById('fileInput').files[0];
            const price = parseFloat(document.getElementById('postPrice').value) || 0;
            if(!file) return alert("Selecciona imagen");

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                await addDoc(collection(db, "posts"), {
                    creador: myData.username,
                    creadorId: myData.id,
                    creadorFoto: myData.fotoPerfil || null,
                    verificado: myData.verificado || false,
                    url: reader.result,
                    precio: price,
                    fecha: new Date().getTime(),
                    likes: [],
                    accesos: [], // IDs de gente que pagó
                    solicitudes: [] // Solicitudes pendientes con capture
                });
                document.getElementById('uploadModal').style.display = 'none';
                navTo('feed');
            };
        };

        // --- EXTRAS ---
        window.toggleLike = async (pid, isLiked) => {
            const ref = doc(db, "posts", pid);
            if(isLiked) await updateDoc(ref, { likes: arrayRemove(myData.id) });
            else await updateDoc(ref, { likes: arrayUnion(myData.id) });
        };

        window.saveBio = async () => {
            const bio = document.getElementById('bioInput').value;
            await updateDoc(doc(db, "usuarios", myData.id), { biografia: bio });
            document.getElementById('p-bio').innerText = bio;
            document.getElementById('bioModal').style.display='none';
        };
        
        window.openBioModal = () => {
             document.getElementById('bioInput').value = document.getElementById('p-bio').innerText;
             document.getElementById('bioModal').style.display = 'flex';
        }

        window.changePhoto = (field) => {
            const input = document.createElement('input'); input.type = 'file'; accept='image/*';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = async () => {
                    await updateDoc(doc(db, "usuarios", myData.id), { [field]: reader.result });
                    loadProfile(myData.id);
                };
                reader.readAsDataURL(e.target.files[0]);
            };
            input.click();
        };

        window.deletePost = async (pid) => { if(confirm("¿Borrar?")) deleteDoc(doc(db, "posts", pid)); };

    </script>
</body>
</html>